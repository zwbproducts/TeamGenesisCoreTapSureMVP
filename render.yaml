services:
  - type: web
    name: tapsure-backend
    env: python
    plan: free
    buildCommand: |
      set -e
      APT_DIR=/tmp/apt
      mkdir -p "$APT_DIR/lists/partial" "$APT_DIR/cache/archives/partial"
      apt-get -o Dir::State="$APT_DIR" -o Dir::State::lists="$APT_DIR/lists" -o Dir::Cache="$APT_DIR/cache" update
      DEBIAN_FRONTEND=noninteractive apt-get \
        -o Dir::State="$APT_DIR" \
        -o Dir::State::lists="$APT_DIR/lists" \
        -o Dir::Cache="$APT_DIR/cache" \
        install -y --no-install-recommends \
        tesseract-ocr \
        libtesseract-dev \
        libleptonica-dev \
        pkg-config
      rm -rf "$APT_DIR"
      pip install -r backend/requirements.txt
    startCommand: "PYTHONPATH=backend uvicorn app.main:app --host 0.0.0.0 --port $PORT"
    autoDeploy: true
    envVars:
      - key: POS_QR_ENFORCEMENT
        value: "on"
      - key: POS_QR_MAX_AGE_SECONDS
        value: "900"
      - key: POS_QR_NONCE_TTL_SECONDS
        value: "3600"
      # Replace with your tenant secrets JSON (required for QR auth)
      - key: POS_TENANT_SECRETS
        value: '{"demo":"dev-secret","customer":"secret1","merchant":"secret2","insurer":"secret3"}'
      # Ensure Tesseract knows where to find tessdata (Render base images place it here)
      - key: TESSDATA_PREFIX
        value: "/usr/share/tesseract-ocr/5/tessdata"
      # Optional: provide an OpenAI-compatible key/base URL/model for smarter chat
      # - key: OPENAI_API_KEY
      #   value: ""
      # - key: LLM_BASE_URL
      #   value: ""
      # - key: LLM_MODEL
      #   value: "llama3.1:8b"
    healthCheckPath: /health
    repo: https://github.com/zeroturnnew-sudo/TapSure-AI-app-Network
    branch: main
